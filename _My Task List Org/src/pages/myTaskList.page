<apex:page controller="myTaskListController" sidebar="false" showHeader="{!pageFormat=='aloha'}" standardStylesheets="false" docType="html-5.0">

    <!-- Bootstrap core CSS -->
    <apex:stylesheet value="{!URLFOR($Resource.myTaskListResources,'/css/bootstrap.min.css')}" />
    <!-- Custom styles for this page -->
    <apex:stylesheet value="{!URLFOR($Resource.myTaskListResources,'/css/myTaskList.css')}" />

<!-- DEBUG USE: determine page isdtp parameter
    <apex:repeat value="{!pageParameters}" var="thisKey" id="params">
        <apex:outputText value="{!thisKey}" /> => <apex:outputText value="{!pageParameters[thisKey]}" /><br />
    </apex:repeat>
-->
        <div class="container">
            <div class="row" style="padding:8px 0;">
                <div class="col-xs-5 text-center">
               		<span id="sortTaskList">
                    	<div class="btn-group">
                    		<button type="button" class="btn btn-default btn-sm dropdown-toggle" id="sortTaskButton" data-toggle="dropdown">
                    			<img src="{!URLFOR($Resource.myTaskListResources,'/images/sort_button.png')}" title="Sort the task list"/>
                    		</button>
                    		<ul class="dropdown-menu text-left" role="menu">
                    			<li><a href="javascript:void(0);" onClick="javascript:location.assign('{!taskSortDateASCScript}');return false;">Soonest due date first</a></li>
                    			<li><a href="javascript:void(0);" onClick="javascript:location.assign('{!taskSortDateDESCScript}');return false;">Farthest due date first</a></li>
                    			<li class="divider"></li>
                    			<li><a href="javascript:void(0);" onClick="javascript:location.assign('{!taskSortPriorityScript}');return false;">High priority first</a></li>
                    		</ul>
                    	</div>
                    </span>
               		<span id="filterTaskList">
                    	<div class="btn-group">
                    		<button type="button" class="btn btn-default btn-sm dropdown-toggle" id="filterTaskButton" data-toggle="dropdown">
                    			<img src="{!URLFOR($Resource.myTaskListResources,'/images/filter_button.png')}" title="Filter the task list" />
                    		</button>
                    		<ul class="dropdown-menu text-left" role="menu">
                    			<li><a href="javascript:void(0);" onClick="javascript:location.assign('{!taskFilterAllOpenScript}');return false;">All Open</a></li>
                    			<li><a href="javascript:void(0);" onClick="javascript:location.assign('{!taskFilterOverdueScript}');return false;">Overdue</a></li>
                    			<li><a href="javascript:void(0);" onClick="javascript:location.assign('{!taskFilterTodayScript}');return false;">Today</a></li>
                    			<li><a href="javascript:void(0);" onClick="javascript:location.assign('{!taskFilterTodayPlusOverdueScript}');return false;">Today + Overdue</a></li>
                    			<li><a href="javascript:void(0);" onClick="javascript:location.assign('{!taskFilterTomorrowScript}');return false;">Tomorrow</a></li>
                    			<li><a href="javascript:void(0);" onClick="javascript:location.assign('{!taskFilterNext7DaysScript}');return false;">Next 7 Days</a></li>
                    			<li><a href="javascript:void(0);" onClick="javascript:location.assign('{!taskFilterNext7DaysPlusOverdueScript}');return false;">Next 7 Days + Overdue</a></li>
                    			<li><a href="javascript:void(0);" onClick="javascript:location.assign('{!taskFilterThisMonthScript}');return false;">This Month</a></li>
                    		</ul>
                    	</div>
                    </span>
                </div>
                <div class="col-xs-4 text-center">
                    <apex:outputLink value="javascript:void(0);" onClick="{!taskNewScript}"><button type="button" class="btn btn-sm btn-primary">New Task</button></apex:outputLink>
                </div>
                <div class="col-xs-3 text-center">
                    <span class="taskAction" id="refreshPage">
                        <a title="Refresh all tasks" href="javascript:void(0);" onClick="javascript:location.reload();return false;" id="refreshPage">
                            <span class="taskAction"><button type="button" class="btn btn-default btn-sm" id="pageRefreshButton"><img src="{!URLFOR($Resource.myTaskListResources,'/images/refresh_button.png')}" /></button></span><br />
                        </a>
                    </span>
                </div>
            </div>
        </div>
        
        <!-- List of Tasks -->
        <div class="panel-group" id="taskList">
            <apex:repeat value="{!myTaskList}" var="myTask" id="taskTable">
            <div class="panel panel-default{!myTask.priorityPanelClass}" id="taskCard{!myTask.taskSObject.Id}">
                <div class="panel-heading" id="taskHeading{!myTask.taskSObject.Id}">
                    <div class="panel-title">
                        <div class="row">
                            <!-- Task Header -->
                            <div class="col-xs-10">
                                <p>
                                    <span class="priorityIcon {!myTask.priorityIconClass}" id="taskPriorityHeader{!myTask.taskSObject.Id}">
                                    	<!-- <img src="/img/high_priority.gif" style="margin:0 0 0 -7px;" alt="High Priority" /> -->
                                    	<img src="{!URLFOR($Resource.myTaskListResources,'/images/priority_icon.png')}" alt="High Priority"/>
                                    </span>
                                    <a href="javascript:void(0);" onclick="{!myTask.taskOpenScript}" id="taskSubjectURL{!myTask.taskSObject.Id}">
                                        <span id="taskSubject{!myTask.taskSObject.Id}">{!myTask.taskSObject.Subject}</span>
                                    </a>
                                </p>
                                <p>
                                    <b>Due: </b>
                                    <span class="{!myTask.dueDateStyle}" id="taskActivityDate{!myTask.taskSObject.Id}">
                                        <apex:outputText value="{0,date,MM'/'dd'/'yyyy}">
                                            <apex:param value="{!myTask.taskSObject.ActivityDate}" />
                                        </apex:outputText>
                                    </span>
                                </p>
                                <p>
                                    <b>RE: </b>
                                    <a href="javascript:void(0);" onclick="{!myTask.taskWhatOpenScript}" id="taskWhatURL{!myTask.taskSObject.Id}">
                                        <span id="taskWhat{!myTask.taskSObject.Id}">{!myTask.taskSObject.What.Name}</span>
                                    </a>
                                </p>
                            </div>
                            <div class="col-xs-2">
                                <a data-toggle="collapse" href="#Task{!myTask.taskSObject.Id}">
                                    <span class="taskAction"><button type="button" class="btn btn-default btn-sm"><img src="{!URLFOR($Resource.myTaskListResources,'/images/details_button.png')}" /></button></span>
                                </a>
                                <span class="taskAction"><button type="button" class="btn btn-default btn-sm hidden" disabled="disabled" id="refreshIndicator{!myTask.taskSObject.Id}"><img style="width:18px;height:18px;" src="{!URLFOR($Resource.myTaskListResources,'/images/loading-gray.gif')}" /></button></span>
                            </div>
                            <!-- /Task Header -->
                        </div>
                    </div>
                </div>
                <div id="Task{!myTask.taskSObject.Id}" class="panel-collapse collapse">
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-xs-10">
                                <!-- Task Details -->
                                <p>
                                    <b>Status: </b>
                                    <span id="taskStatus{!myTask.taskSObject.Id}">{!myTask.taskSObject.Status}</span>
                                    <input type="hidden" id="statusPriorValue{!myTask.taskSObject.Id}" value="{!myTask.taskSObject.Status}" />
                                </p>
                                <p>
                                    <b>Priority: </b>
                                    <input type="hidden" id="priorityOriginalValue{!myTask.taskSObject.Id}" value="{!myTask.taskSObject.Priority}" />
                                    <span id="taskPriority{!myTask.taskSObject.Id}">{!myTask.taskSObject.Priority}</span>
                                    <span class="priorityIcon {!myTask.priorityIconClass}" id="taskPriorityDetails{!myTask.taskSObject.Id}">
                                        <!-- <img src="/img/high_priority.gif" style="margin:0 0 0 -7px;" alt="High Priority" /> -->
                                    	<img src="{!URLFOR($Resource.myTaskListResources,'/images/priority_icon.png')}" alt="High Priority"/>
                                    </span>
                                </p>
                                <p>
                                    <b>Type: </b>
                                    <span id="taskType{!myTask.taskSObject.Id}">{!myTask.taskSObject.Type}</span>
                                </p>
                                <p>
                                    <b>Who: </b>
                                    <a href="javascript:void(0);" onclick="{!myTask.taskWhoOpenScript}" id="taskWhoURL{!myTask.taskSObject.Id}">
                                        <span id="taskWho{!myTask.taskSObject.Id}">{!myTask.taskSObject.Who.Name}</span>
                                    </a>
                                </p>
                                <p>
                                    <b>Description: </b><br />
                                    <span id="taskDescription{!myTask.taskSObject.Id}"><apex:outputText escape="false" value="{!myTask.taskSObject.Description}" /></span>
                                </p>
                                <!-- /Task Details -->
                            </div>
                            <div class="col-xs-2" id="taskActionButtons{!myTask.taskSObject.Id}">
                                <!-- Task Actions -->
                                <a title="Refresh task details" href="javascript:void(0);" onClick="javascript:MTL_updateTask('{!myTask.taskSObject.Id}',null,null);" id="taskRefreshLink{!myTask.taskSObject.Id}">
                                    <span class="taskAction"><button type="button" class="btn btn-default btn-sm" id="taskRefreshButton{!myTask.taskSObject.Id}"><img src="{!URLFOR($Resource.myTaskListResources,'/images/refresh_button.png')}" /></button></span><br />
                                </a>
                                <a title="One click completion toggle of this task" href="javascript:void(0);" onClick="javascript:MTL_updateTask('{!myTask.taskSObject.Id}','Status','Completed');" id="taskQuickCloseLink{!myTask.taskSObject.Id}">
                                    <span class="taskAction"><button type="button" class="btn btn-danger btn-sm" id="taskQuickCloseButton{!myTask.taskSObject.Id}"><img src="{!URLFOR($Resource.myTaskListResources,'/images/close_quick_button.png')}" /></button></span><br />
                                </a>
                                <apex:outputLink title="Mark task complete and add notes" value="javascript:void(0);" onClick="{!myTask.taskCloseScript}" rendered="{!pageFormat != 'mobile'}">
                                    <span class="taskAction"><button type="button" class="btn btn-default btn-sm" id="taskCloseButton{!myTask.taskSObject.Id}"><img src="{!URLFOR($Resource.myTaskListResources,'/images/close_button.png')}" /></button></span><br />
                                </apex:outputLink>
                                <a title="Edit this task" href="javascript:void(0);" onClick="{!myTask.taskEditScript}">
                                    <span class="taskAction"><button type="button" class="btn btn-default btn-sm" id="taskEditButton{!myTask.taskSObject.Id}"><img src="{!URLFOR($Resource.myTaskListResources,'/images/edit_button.png')}" /></button></span><br />
                                </a>
                                <a title="One click priority toggle for this task" href="javascript:void(0);" onClick="javascript:MTL_togglePriority('{!myTask.taskSObject.Id}');return false;" id="taskTogglePriorityLink{!myTask.taskSObject.Id}">
                                    <span class="taskAction"><button type="button" class="btn btn-default btn-sm" id="taskTogglePriorityButton{!myTask.taskSObject.Id}"><img src="{!URLFOR($Resource.myTaskListResources,'/images/priority_button.png')}" /></button></span><br />
                                </a>
                                <a title="Email this task to myself" href="javascript:void(0);" onClick="javascript:MTL_emailTask('{!myTask.taskSObject.Id}');return false;" id="taskEmailLink{!myTask.taskSObject.Id}">
                                    <span class="taskAction"><button type="button" class="btn btn-default btn-sm" id="taskEmailButton{!myTask.taskSObject.Id}"><img src="{!URLFOR($Resource.myTaskListResources,'/images/mail_button.png')}" /></button></span><br />
                                </a>
                                <!-- /Task Actions -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </apex:repeat>
        </div>
        <!-- /Table of Activities -->
    
    <!-- ========================================================================================
    	JavaScript Includes - placed at the end of the document so the pages load faster -->

    <!--  Bootstrap core JavaScript -->
    <apex:includeScript value="{!URLFOR($Resource.myTaskListResources,'/js/jquery-1.11.0.min.js')}"/> 
    <apex:includeScript value="{!URLFOR($Resource.myTaskListResources,'/js/bootstrap.min.js')}"/> 
    
    <!--  cometD Javascript for subscribing to the salesforce.com Streaming API -->
    <apex:includeScript value="{!URLFOR($Resource.myTaskListResources,'/js/cometd-2.2.0.js')}"/> 
    <apex:includeScript value="{!URLFOR($Resource.myTaskListResources,'/js/jquery.cometd-2.2.0.js')}"/> 

    <!-- Salesforce Console integration JavaScript -->
    <apex:includeScript value="/support/console/30.0/integration.js"/> 

    <!-- Custom JavaScript for My Task List -->
    <apex:includeScript value="{!URLFOR($Resource.myTaskListResources,'/js/myTaskList.js')}"/> 
    <script type="text/javascript">
		/* 
			getPageFormat - get the pageFormat string based on the user's UI
				NOTE: this JavaScript function is included in the VF page file due to
				the inline Visualforce merge field
			Inputs: none
			Output: String pageFormat = console, mobile, or aloha
		*/
		function getPageFormat() {
			// Detect the page format
			var pageisdtp = "{!$CurrentPage.parameters.isdtp}";
			var pageFormat = "aloha";
			if (pageisdtp == 'nv' || pageisdtp == 'vw') {
				// Detect the console
				pageFormat = "console";
			} else if ( pageisdtp == 'p1' ) {
				// Detect Salesforce1
				pageFormat = "mobile";
			} else {
				// Default to aloha
				pageFormat = "aloha";
			}
        
			// Return the page format
			return pageFormat;
		}

		/*
			Listen for and handle changes to tasks
				NOTE: this JavaScript function is included in the VF page file due to
				the inline Visualforce merge field
		*/
		(function($){
			$(document).ready(function() {
				// Connect to the CometD endpoint
				$.cometd.init({
					url: window.location.protocol+'//'+window.location.hostname+'/cometd/30.0/',
					requestHeaders: { Authorization: 'OAuth {!$Api.Session_ID}'},
					appendMessageTypeToURL: false
				});
	
				// Subscribe to the myTaskListUpdates topic and refresh the task list
				//  when a task assigned to this user is created or updated
				$.cometd.subscribe('/topic/myTaskListUpdates', function(message) {
					// Determine the event type (create, update, delete)
					var thisEventType = message.data.event.type;
					// Get the Task Id and Task OwnerId from the updated Task
					var thisTaskId = message.data.sobject.Id;
					var thisTaskOwnerId = message.data.sobject.OwnerId;

					// If a task for the updated Id exists in the page, update it
					if ($("#taskCard"+thisTaskId).length >= 1) {
  						MTL_updateTask(thisTaskId,null,null);
    				}
					// If a new or deleted task is detected and owned by (Assigned To) user,
					//	refresh the entire task list
					if ((thisEventType == "created" || thisEventType == "deleted") && thisTaskOwnerId == "{!$User.Id}") {
						location.reload();
					}
				});
			});
		})(jQuery)		
	</script>
    
</apex:page>